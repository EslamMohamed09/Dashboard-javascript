<?php
/*
 =========================
 = customers
 =========================
*/

ob_start();
session_start();

if (!isset($_SESSION['Admin'])){
    header('Location:admin_login.php');
    exit();
}

$pageTitle = 'customers';
include 'init.php';
include 'admin_header.php';

$do = isset($_GET['do']) ? $_GET['do'] : 'Manage';

if($do == 'Manage') {

  if($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['multipledelete']) && isset($_POST['checkbox'])) { // multiple delete customers

      $selectedDeleteCustomers = implode(',', $_POST['checkbox']);

      $delete_customer = $conn->prepare("DELETE FROM `customers` WHERE cust_id IN ($selectedDeleteCustomers)");
      $delete_customer->execute();
      $deleteCount = $delete_customer->rowCount();

      $successMsgWithCount = [$deleteCount, "customers deleted successfully"];

      $_SESSION['successMsg'] = implode(' ', $successMsgWithCount);

      header("Location: ".$_SERVER['PHP_SELF']);
      exit;

  }

$sort = 'DESC';
$sort_array = ['ASC', 'DESC'];
if(isset($_GET['sort']) && in_array($_GET['sort'], $sort_array)) {$sort = $_GET['sort'];}

$limit = 30;
if(isset($_GET['page'])) {$page = $_GET['page'];} else {$page = 1;}
$start = ($page - 1) * $limit;

$select_customers = $conn->prepare("SELECT * FROM customers ORDER BY cust_id $sort LIMIT $start, $limit");
$select_customers->execute();
$customers = $select_customers->fetchAll();

?>

  <section class="dashboard-section" id="dashboard-section"> <!-- MANAGE CUSTOMERS -->

    <?php include 'aside.php';?>

    <div class="main-data main-customers">

        <h1 class="section-heading">manage customers</h1>

        <div class="customer-container">

            <?php if (!empty ($customers)){ ?>

              <div class="table-details">

                  <form class="form-search d-flex-r-st-c" action="customer_search.php" method="POST">
                    <input type="search" name="search" placeholder="Search Customer" id="searchinput-customers">
                    <button type="submit" name="submit-search" id="submit-search"><i class="fas fa-search" id="submit-searchi"></i></button>
                  </form>

                  <div class="counting">
                    <span>all customers</span> 
                    <span class="no"><?php echo countItems('cust_id', 'customers') ?></span>
                  </div>

                  <div class="ordering-btns">
                    <a href="?sort=ASC" class="<?php if ($sort == 'ASC'){echo 'active';} ?>">ASC</a> /
                    <a href="?sort=DESC" class="<?php if ($sort == 'DESC'){echo 'active';} ?>">DESC</a> 
                  </div>

              </div>

              <form action="<?php echo $_SERVER['PHP_SELF'];?>" method="POST" style="width:100%;"> <!-- multiple delete form -->

                <table>

                  <thead>
                    <tr>
                      <th><input type="checkbox" id="first-all-checkbox" class="checkboxinput"></th>
                      <th><label for="first-all-checkbox">fullname</label></th>
                      <th>email</th>
                      <th>phone no.</th>
                      <th>image</th>
                      <th>gender</th>
                      <th>country</th>
                      <th>city</th>
                      <th>po. code</th>
                      <th>question</th>
                      <th>date</th>
                      <th>iD</th>
                    </tr>
                  </thead>

                  <tbody>

                    <?php foreach ($customers as $customer){ ?>

                        <tr>
                          <td><input type="checkbox" id="cu-name-<?php echo $customer['cust_id'];?>" class="checkboxinput" name="checkbox[]" value="<?php echo $customer['cust_id'];?>"></td>
                          <td>
                              <label for="cu-name-<?php echo $customer['cust_id'];?>"><?php echo $customer['fullname'];?></label>
                              <div class="buttons">
                                <a href="?do=Edit&custid=<?php echo $customer['cust_id'];?>" target="_blank">edit</a>|
                                <a href="?do=Delete&custid=<?php echo $customer['cust_id'];?>" class="confirm">delete</a>
                              </div>
                          </td>
                          <td><?php echo $customer['email'];?></td>
                          <td><?php echo $customer['phone_no'];?></td>
                          <td><?php echo $customer['cust_image'];?></td>
                          <td><?php echo $customer['gender'];?></td>
                          <td><?php echo $customer['country'];?></td>
                          <td><?php echo $customer['city'];?></td>
                          <td><?php echo $customer['postalcode'];?></td>
                          <td><?php echo $customer['question'];?></td>
                          <td><?php echo $customer['date'];?></td>
                          <td><?php echo $customer['cust_id'];?></td>
                        </tr>
                        
                    <?php } ?>

                  </tbody>

                  <thead>
                    <tr>
                      <th><input type="checkbox" id="second-all-checkbox" class="checkboxinput"></th>
                      <th><label for="second-all-checkbox">fullname</label></th>
                      <th>email</th>
                      <th>phone no.</th>
                      <th>image</th>
                      <th>gender</th>
                      <th>country</th>
                      <th>city</th>
                      <th>po. code</th>
                      <th>question</th>
                      <th>date</th>
                      <th>iD</th>
                    </tr>
                  </thead>

                </table>

                <div class="pagination">

                  <?php $totalrecords = countItems("cust_id", "customers");
                        $totalPages = ceil($totalrecords/$limit);

                  if($totalrecords > $limit){

                    if($page > 1){?>
                      <a href="?page=<?php echo ($page-1);?>" class="pagination-link previous"><i class="fas fa-chevron-left"></i> previous</a>
                    <?php } 

                    $visiblePages = 3;
                    $range = min($visiblePages, $totalPages);

                    if ($page <= $range) {
                      for ($i = 1; $i <= $range; $i++) {
                        $active_class = ($i == $page) ? " active" : "";
                        ?>
                        <a href="?page=<?php echo $i;?>" class="pagination-link<?php echo $active_class;?>"><?php echo $i;?></a>
                      <?php }
                      if ($totalPages > $visiblePages) {
                        echo '<span class="pagination-dots">....</span>';
                        echo '<a href="?page=' . $totalPages . '" class="pagination-link">' . $totalPages . '</a>';
                      }
                    } elseif ($page > ($totalPages - $range + 1)) {
                      echo '<a href="?page=1" class="pagination-link">1</a>';
                      echo '<span class="pagination-dots">....</span>';
                      for($i = $totalPages - $range + 1; $i <= $totalPages; $i++) {$active_class = ($i == $page) ? " active" : "";?>
                        <a href="?page=<?php echo $i;?>" class="pagination-link<?php echo $active_class;?>"><?php echo $i;?></a>
                      <?php }
                    } else {
                      echo '<a href="?page=1" class="pagination-link">1</a>';
                      echo '<span class="pagination-dots">....</span>';
                      for($i = $page - floor($visiblePages / 2); $i <= $page + floor($visiblePages / 2); $i++) {$active_class = ($i == $page) ? " active" : "";?>
                        <a href="?page=<?php echo $i;?>" class="pagination-link<?php echo $active_class;?>"><?php echo $i;?></a>
                      <?php }
                      echo '<span class="pagination-dots">....</span>';
                      echo '<a href="?page=' . $totalPages . '" class="pagination-link">' . $totalPages . '</a>';
                    }?>

                    <?php if($page < $totalPages){?>
                      <a href="?page=<?php echo ($page+1);?>" class="pagination-link next">next <i class="fas fa-chevron-right"></i></a>
                    <?php }

                  } ?>

                </div>

                <div class="submit-buttons d-flex-r-st-c" style="gap:2rem;width:fit-content;display:none;">
                  <input type="submit" name="multipledelete" value="delete" class="btn2" style="padding:0.5rem 1rem;margin-left:0.5rem;margin-top:1rem;">
                </div>

              </form>

              <?php if(!empty($_SESSION['successMsg'])){?>
                 <p class="success-message d-flex-r-st-st">
                   <?php echo $_SESSION['successMsg'];?>
                   <i class="fas fa-times" id="icon" onclick="this.parentElement.remove();"></i>
                 </p>
              <?php unset($_SESSION['successMsg']);} ?>

            <?php } else {echo '<p class="there-is-no">There is No Customers</p>';} ?>

        </div> <!-- End Customer Table -->

    </div> <!-- ===== End Main-Data ==== -->

  </section>

<?php } elseif ($do == 'Edit') { 

    $customerid = isset($_GET['custid']) && is_numeric($_GET['custid']) ? intval($_GET['custid']) : 0;
    $customer = getRowData("customers", "cust_id", $customerid);

    if(count($customer) > 0){

 ?>
  
    <section class="dashboard-section" id="dashboard-section">

      <?php include 'aside.php';?>

      <div class="main-data edit-page container">

        <h1 class="text-center edit-heading">edit customer <?php echo $customer['fullname'];?></h1>

        <form class="row" action="?do=Update" method="POST">

          <input type="hidden" name="customerid" value="<?php echo $customerid;?>">

          <div class="col-md-8 input-boxes d-flex-c-st-c">

            <div class="input-box d-flex-r-bt-c">  <!-- Customer Fullname -->
              <label class="control-label">Fullname</label>
              <input type="text" name="fullname" maxlength="18" pattern=".{4,18}" value="<?php echo $customer['fullname'];?>" class="form_control" required/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer Email -->
              <label class="control-label">Email</label>
              <input type="text" name="email" maxlength="45" value="<?php echo $customer['email'];?>" class="form_control" required/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer Phone number -->
              <label class="control-label">phone number</label>
              <input type="text" name="phone_no" maxlength="20" pattern=".{3,20}" value="<?php echo $customer['phone_no'];?>" class="form_control" required/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer Password -->
              <label class="control-label">password</label>
              <div class="pass-col">
                <input type="password" name="newpassword" id="passInput" style="width:100%;" autocomplete="new-password" class="form_control"/>
                <div class="eye" onclick="eyeFunction()">
                  <i class="fa fa-eye" id="faeye-1"></i> 
                  <i class="fa fa-eye-slash" id="faeye-2"></i> 
                </div>
              </div>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer gender -->
              <label class="control-label">gender</label>
              <select name="gender" class="form_control">
                <option value="male" <?php if ($customer['gender'] == 'male') {echo 'selected';} ?>> male </option>
                <option value="female" <?php if ($customer['gender'] == 'female') {echo 'selected';} ?>> female </option>
              </select>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer Country -->
              <label class="control-label">customer country</label>
              <?php include 'temp/customer_country.php';?>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer city -->
              <label class="control-label">city</label>
              <input type="text" name="customercity" maxlength="16" pattern=".{4,16}" value="<?php echo $customer['city'];?>" class="form_control" required/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer address -->
              <label class="control-label">address</label>
              <input type="text" name="customeraddress" maxlength="35" pattern=".{11,35}" value="<?php echo $customer['address'];?>" class="form_control" required/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer Postal code -->
              <label class="control-label">Postal code</label>
              <input type="text" name="customerpostalcode" maxlength="10" pattern=".{4,10}" value="<?php echo $customer['postalcode'];?>" class="form_control" required/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- Customer visa number -->
              <label class="control-label">visa number</label>
              <input type="text" name="customervisa_no" id="visaInput" maxlength="19" pattern=".{3,19}" value="<?php echo $customer['visa_no'];?>" class="form_control"/>
            </div>

            <div class="input-box d-flex-r-bt-c">  <!-- QUESTIONS -->
              <label class="control-label">questions</label>
              <select name="question" class="form_control" id="question_select" onchange="selectquestion()">
                <option value="0" <?php if ($customer['question'] == '0') {echo 'selected';} ?>> choose question </option>
                <option value="father name" <?php if ($customer['question'] == 'father name') {echo 'selected';} ?>> father name </option>
                <option value="school name" <?php if ($customer['question'] == 'school name') {echo 'selected';} ?>> school name </option>
                <option value="favourite time" <?php if ($customer['question'] == 'favourite time') {echo 'selected';} ?>> favourite time </option>
                <option value="favourite sport" <?php if ($customer['question'] == 'favourite sport') {echo 'selected';} ?>> favourite sport </option>
                <option value="other" <?php if ($customer['question'] == 'other') {echo 'selected';} ?>> other </option>
              </select>
            </div>

            <div class="input-box d-flex-r-bt-c" id="other_question"> <!-- other question -->
              <label class="control-label">other question</label>
              <input type="text" name="otherquestion" class="form_control" value="<?php echo $customer['other_question'];?>">
            </div>

            <div class="input-box d-flex-r-bt-c" id="answer_question"> <!-- answer -->
              <label class="control-label">answer question</label>
              <input type="text" name="answer" class="form_control" maxlength="35" pattern=".{3,35}" value="<?php echo $customer['answer'];?>" required/>
            </div>

          </div> <!-- End col-md-8 -->

          <div class="col-md-4 img-box d-flex-c-c-c">
            <h4>customer image</h4>
            <input type="file">
            <img src="inc/img/Perfume/perfume.png" alt="">
          </div> <!-- End col-md-4 -->
          
          <input type="submit" value="update" class="btn"/>

        </form>

      </div> <!-- ===== End Main-Data ==== -->

    </section>

  <?php } else { ?>

     <section class="dashboard-section" id="dashboard-section">

        <?php include 'aside.php';?>

        <div class="main-data main-customers">

            <div class="customer-container">
              
              <?php $theMsg = '<p class="wrong-message d-flex-r-st-st" style="margin:10rem auto 1rem;">There No Customer <i class="fas fa-times" id="icon" onclick="this.parentElement.remove();"></i> 
                               </p>';?>
              <?php redirectPage($theMsg, 'back');?>

            </div> <!-- End Customer container -->

        </div> <!-- ===== End Main-Data ==== -->

     </section> 

  <?php }

} elseif ($do == 'Update'){

    $arabicPattern = '/[\p{Arabic}]/u';
    $symbolsPattern = '/[!@#$%^&*()\-_=+[\]{};:\'",.<>?`~\\\\|]/';

    if($_SERVER['REQUEST_METHOD'] == 'POST') {

       $customerid         = $_POST['customerid'];
       $fullname           = strtolower(preg_replace('/[^A-Za-z\s]/', '', $_POST['fullname']));
       $email              = filter_var($_POST['email'], FILTER_SANITIZE_EMAIL);
       $phone_no           = filter_var($_POST['phone_no'], FILTER_SANITIZE_NUMBER_INT);
       $newpassword        = removestrings($_POST['newpassword']);
       $gender             = $_POST['gender'];
       $customer_country   = $_POST['customer_country'];
       $customercity       = removestrings($_POST['customercity']);
       $customeraddress    = removestrings($_POST['customeraddress']);
       $customerpostalcode = filter_var($_POST['customerpostalcode'], FILTER_SANITIZE_NUMBER_INT);
       $customervisa_no    = filter_var($_POST['customervisa_no'], FILTER_SANITIZE_NUMBER_INT);
       $question           = $_POST['question'];
       if(isset($_POST['otherquestion'])) {$otherquestion = removestrings($_POST['otherquestion']);}
       $answer             = removestrings($_POST['answer']);

       if(empty($fullname)) {$formErrors[] = 'full name cant be empty';}
       if(strlen($fullname) < 4 && strlen($fullname) > 0) {$formErrors[] = 'full name is too short, must more than 3 letters';}
       if(strlen($fullname) > 18) {$formErrors[] = 'full name is too long, must less than 19 letters';}

       if(empty($email)) {$formErrors[] = 'email cant be empty';}
       if(strlen($email) > 45) {$formErrors[] = 'email is too long, must less than 46 letters';}
      
       if(empty($phone_no)) {$formErrors[] = 'phone number cant be empty';}
       if(strlen($phone_no) < 6) {$formErrors[] = 'phone number is too short, must more than 6 letters';}
       if(strlen($phone_no) > 12) {$formErrors[] = 'phone number is too long, must less than 12 letters';}
 
       if(strlen($newpassword) < 8 && strlen($newpassword) > 0) {$formErrors[] = 'password is too short, must more than 7 letters';}
       if(strlen($newpassword) > 30) {$formErrors[] = 'password is too long, must less than 30 letters';}
       if(preg_match($arabicPattern, $newpassword)) {$formErrors[] = 'not allow to use arabic language';}
       if(preg_match($symbolsPattern, $newpassword)) {$formErrors[] = 'not allow to write any symbol';}

       if(empty($customercity)) {$formErrors[] = 'city cant be empty';}
       if(strlen($customercity) < 4 || strlen($customercity) > 16) {$formErrors[] = 'error name of city';}
       if(preg_match($arabicPattern, $customercity)) {$formErrors[] = 'not allow to use arabic language';}
       if(preg_match($symbolsPattern, $customercity)) {$formErrors[] = 'not allow to write any symbol';}

       if(empty($customeraddress)) {$formErrors[] = 'address cant be empty';}
       if(strlen($customeraddress) < 11) {$formErrors[] = 'address is too short';}
       if(strlen($customeraddress) > 35) {$formErrors[] = 'address is too long';}
       if(preg_match($arabicPattern, $customeraddress)) {$formErrors[] = 'not allow to use arabic language';}
       if(preg_match($symbolsPattern, $customeraddress)) {$formErrors[] = 'not allow to write any symbol';}

       if(empty($customerpostalcode)) {$formErrors[] = 'postal code cant be empty';}
       if(strlen($customerpostalcode) < 4 && strlen($customerpostalcode) > 0) {$formErrors[] = 'error postal code';}
       if(strlen($customerpostalcode) > 10) {$formErrors[] = 'error postal code, must less than 11 letters';}

       if(strlen($customervisa_no) < 19 && strlen($customervisa_no) > 0) {$formErrors[] = 'error visa number cant be less than 16 character';}
       if(strlen($customervisa_no) > 19) {$formErrors[] = 'error visa number cant be more than 16 character';}

       if($question == '0') {$formErrors[] = 'must choose question until reset your account';}

       if(isset($otherquestion) && $question == 'other'){
          if(empty($otherquestion)) {$formErrors[] = 'write your other question !';}
          if(preg_match($arabicPattern, $otherquestion)) {$formErrors[] = 'not allow to use arabic language';}
          if(preg_match($symbolsPattern, $otherquestion)) {$formErrors[] = 'not allow to write any symbol';}
       }

       if(empty($answer)) {$formErrors[] = 'must write answer of the question !';}
       if(strlen($answer) > 35) {$formErrors[] = 'answer is too long, must less than 36 letters';}
       if(preg_match($arabicPattern, $answer)) {$formErrors[] = 'not allow to use arabic language';}
       if(preg_match($symbolsPattern, $answer)) {$formErrors[] = 'not allow to write any symbol';}


      $update_values[] = $customerid;

      if(!empty($newpassword)) {$update_fields[] = 'password = ?';
                                $update_values[] = sha1($newpassword);}
      
      if(isset($email)) {$update_fields[] = 'email = ?';
                         $update_values[] = $email;}
      
      if(isset($phone_no)) {$update_fields[] = 'phone_no = ?';
                            $update_values[] = $phone_no;}

      if(isset($fullname)) {$update_fields[] = 'fullname = ?';
                            $update_values[] = $fullname;}
      
      if(isset($gender)) {$update_fields[] = 'gender = ?';
                          $update_values[] = $gender;}
      
      if(isset($customer_country)) {$update_fields[] = 'country = ?';
                                    $update_values[] = $customer_country;}

      if(isset($customercity)) {$update_fields[] = 'city = ?';
                                $update_values[] = $customercity;}
      
      if(isset($customeraddress)) {$update_fields[] = 'address = ?';
                                   $update_values[] = $customeraddress;}
      
      if(isset($customerpostalcode)) {$update_fields[] = 'postalcode = ?';
                                      $update_values[] = $customerpostalcode;}

      if(isset($customervisa_no)) {$update_fields[] = 'visa_no = ?';
                                   $update_values[] = $customervisa_no;}
      
      if(isset($question)) {$update_fields[] = 'question = ?';
                            $update_values[] = $question;}
      
      if(isset($otherquestion)) {$update_fields[] = 'other_question = ?';
                                 $update_values[] = $otherquestion;}

      if($question !== 'other' && $question !== '0') {$update_fields[] = 'other_question = ?';
                                                      $update_values[] = '';}

      if(isset($answer)) {$update_fields[] = 'answer = ?';
                          $update_values[] = $answer;}


      if(empty($formErrors) && !empty($update_fields)){

          // # Shure that data not same before upload to database
          $sameCust = $conn->prepare("SELECT * FROM customers WHERE cust_id = ? AND " . implode('AND ', $update_fields));
          $sameCust->execute($update_values);
          $sameCustCount = $sameCust->rowCount();

          if($sameCustCount == 1){ // check if written customer data is the same customer data I bringed it from database not update to database
             $theMsg = '<p class="single-top-wrong-message d-flex-r-st-c"> No changes have been made <i class="fas fa-times" id="icon" onclick="this.parentElement.remove();"></i></p>';
             redirectPage($theMsg, 'back');
          } else {
             array_shift($update_values);    // Delete customerid from first of array
             $update_values[] = $customerid; // Add customerid in the end of 

             $update_customer = $conn->prepare("UPDATE customers SET " . implode(', ', $update_fields) . " WHERE cust_id = ? ");
             $update_customer->execute($update_values);

             $theMsg = '<p class="success-message d-flex-r-st-c">Customer Updated <i class="fas fa-times" id="icon" onclick="this.parentElement.remove();"></i></p>';
             redirectPage($theMsg, 'back');
          }

        }

        if(!empty($formErrors)){?>
          <div class="top-wrong-messages d-flex-c-st-st">
            <?php foreach($formErrors as $formError) {echo '<p class="wrong-message d-flex-r-st-st">' . $formError . '<i class="fas fa-times" id="ticon" onclick="this.parentElement.remove();"></i></p>';}
            $theMsg = '<p class="error-msg">error</p>';
            redirectPage($theMsg, 'back');?>
          </div>
        <?php }

    } else { ?>

      <section class="dashboard-section" id="dashboard-section"> <!-- You Cant Browse This Page Directly -->

          <?php include 'aside.php';?>

          <div class="main-data main-customers">

            <div class="customer-container">
              <?php $theMsg = '<p class="single-top-wrong-message d-flex-r-st-st">Sorry You Cant Browse This Page Directly <i class="fas fa-times" id="ticon" onclick="this.parentElement.remove();"></i></p>';?>
              <?php redirectPage($theMsg, 'back');?>
            </div> <!-- End Customer Container -->

          </div> <!-- ===== End Main-Data ==== -->

      </section>

    <?php } 

} elseif ($do == 'Delete'){

  $customerid = isset($_GET['custid']) && is_numeric($_GET['custid']) ? intval($_GET['custid']) : 0;

  $customerCheck = checkItem('cust_id', 'customers', $customerid);

  if($customerCheck == 1){

     $select_customer = $conn->prepare("DELETE FROM `customers` WHERE cust_id = ?");
     $select_customer->execute([$customerid]);

     $theMsg = '<p class="top-success-message d-flex-r-st-c">Customer Deleted <i class="fas fa-times" id="icon" onclick="this.parentElement.remove();"></i></p>';
     redirectPage($theMsg, 'back');

  } else {
    $theMsg = '<p class="single-top-wrong-message d-flex-r-st-st">there is no customer <i class="fas fa-times" id="icon" onclick="this.parentElement.remove();"></i></p>';
    redirectPage($theMsg, 'back');
  }

} ?>

<?php include 'footer.php';?>
<?php ob_end_flush();?>